#!/bin/bash

# A quick script to explicitly allow ssh connections in from the calling IP

set -euo pipefail
err_report() {
    echo "errexit on line $(caller)" >&2
}
trap err_report ERR

SCRIPT_DIR=$(dirname $(readlink -f $0))

declare -A PO_SHORT_MAP
# no short options
declare -A PO_LONG_MAP
PO_LONG_MAP["comment:"]="COMMENT"
. ${SCRIPT_DIR}/parse-opt.sh

if [[ ! $COMMENT ]]; then
    COMMENT="added by $0"
fi

ssh_connection_array=($SSH_CONNECTION)
sources=(${ssh_connection_array[0]})
if [[ $@ ]]; then
    sources="$@"
fi
for source in "${sources[@]}"; do
    ufw allow to any app OpenSSH from "${source}" comment "${COMMENT}"
done
